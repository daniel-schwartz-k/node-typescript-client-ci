name: Generate Client
        
on: 
  - ['push']
  - workflow_dispatch:
  - schedule:
    # Every day at 12:00 AM and 12:00 PM
    - cron:  '* 0,12 * * *'

jobs:
  update:
    runs-on: ubuntu-22.04
    steps:
    - name: ğŸ“¦ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: 7.4
    - name: â¬¡ Setup Node
      uses: actions/setup-node@v3
      with:
        node-version: 14.21.3
    - name: â¬‡ Checkout
      uses: actions/checkout@v3
    - name: â˜ï¸ Clone
      run: |
        git clone https://github.com/kaltura/clients-generator.git
        ls -la
    - name: ğŸ”„ Fetch latest scheme
      run: | 
        wget http://www.kaltura.com/api_v3/api_schema.php -O api_schema.php.xml
        version=`cat api_schema.php.xml | grep apiVersion | grep -oP 'apiVersion=[^ ]+'`
        echo "Got schema ${version}"
    - name: âš™ï¸ Generate
      run: |
        mkdir client
        php ./clients-generator/exec.php -x$PWD/api_schema.php.xml -r$PWD/client nodeTypescript
    - name: ğŸ› ï¸ Build
      run: |
        cd ./client/web/content/clientlibs/nodeTypescript
        npm i
        npm run deploy
      # TODO save name for next step so we can upload only the package..
      #  NewClientName=`ls dist | grep kaltura-node-typescript-client`
      # /nodeTypescript/dist/$NewClientName
        rm -rf ./dist/node_modules
    - name: ğŸ“¤ Upload
      uses: actions/upload-artifact@v3
      with:
        name: kaltura-node-typescript-client
        path: ./client/web/content/clientlibs/nodeTypescript/dist