name: Generate Client
        
on: 
  push:
  workflow_dispatch:
  schedule:
    # Every day at 12:00 AM and 12:00 PM
    - cron:  '* 0,12 * * *'

jobs:
  update:
    runs-on: ubuntu-22.04
    steps:
    - name: üì¶ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: 7.4
    - name: ‚¨° Setup Node
      uses: actions/setup-node@v3
      with:
        node-version: 14.21.3
    - name: ‚¨á Checkout
      uses: actions/checkout@v3
    - name: ‚òÅÔ∏è Clone
      run: |
        git clone https://github.com/kaltura/clients-generator.git
        ls -la
    - name: üîÑ Fetch latest scheme
      id: schema
      run: | 
        wget http://www.kaltura.com/api_v3/api_schema.php -O api_schema.php.xml
        version=`cat api_schema.php.xml | grep apiVersion | grep -oP 'apiVersion=[^ ]+'`
        echo "Got schema ${version}"
        echo "::set-output name=version::${version}"
    - name: ‚öôÔ∏è Generate
      id: generated
      run: |
        mkdir client
        php ./clients-generator/exec.php -x$PWD/api_schema.php.xml -r$PWD/client nodeTypescript
        echo "::set-output name=label::$(`ls dist | grep kaltura-node-typescript-client`)"
    - name: üõ†Ô∏è Build
      run: |
        cd ./client/web/content/clientlibs/nodeTypescript
        npm i
        npm run deploy
    - name: Get current date
      id: date
      run: echo "::set-output name=date::$(date +'%Y-%m-%d')"
    - name: üöÄ Release
      env:
        SCHEMA_VERSION: ${{ steps.schema.outputs.version }}
        GENERATED_LABEL: ${{ steps.generated.outputs.label }}
      uses: softprops/action-gh-release@v1
      with:
        files: ./client/web/content/clientlibs/nodeTypescript/dist/kaltura-node-typescript-client-*
        name: ${SCHEMA_VERSION}
        body: |
          Release of ${GENERATED_LABEL} 
          ${SCHEMA_VERSION}