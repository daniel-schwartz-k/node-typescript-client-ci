name: Generate Client
        
on: 
  push:
  workflow_dispatch:
  schedule:
    # Every day at 12:00 AM and 12:00 PM
    - cron:  '* 0,12 * * *'

jobs:
  update:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
    - name: ğŸ“¦ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: 7.4
    - name: â¬¡ Setup Node
      uses: actions/setup-node@v3
      with:
        node-version: 14.21.3
    - name: â¬‡ Checkout
      uses: actions/checkout@v3
    - name: â˜ï¸ Clone
      run: |
        git clone https://github.com/kaltura/clients-generator.git
        ls -la
    - name: ğŸ”„ Fetch latest scheme
      run: | 
        wget http://www.kaltura.com/api_v3/api_schema.php -O api_schema.php.xml
        version=`cat api_schema.php.xml | grep apiVersion | grep -oP 'apiVersion=[^ ]+'`
        echo "Got schema ${version}"
        echo "schema_version=${version}" >> "$GITHUB_ENV"
    - name: âš™ï¸ Generate
      run: |
        mkdir client
        php ./clients-generator/exec.php -x$PWD/api_schema.php.xml -r$PWD/client nodeTypescript
        echo "generated_name=$(`ls dist | grep kaltura-node-typescript-client`)" >> "$GITHUB_ENV"
    - name: ğŸ› ï¸ Build
      run: |
        cd ./client/web/content/clientlibs/nodeTypescript
        npm i
        npm run deploy
    - name: Get current date
      id: date
      run: echo "::set-output name=date::$(date +'%Y-%m-%d')"
    - name: ğŸš€ Release
      uses: softprops/action-gh-release@v1
      with:
        files: ./client/web/content/clientlibs/nodeTypescript/dist/kaltura-node-typescript-client-*
        name: $schema_version
        tag_name: $generated_name
        body: |
          Release of $generated_name 
          $schema_version